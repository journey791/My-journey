<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Trading Journal Pro — Dashboard + Journey (IndexedDB)</title>
<style>
  :root{
    --bg:#071025; --bg2:#071827; --card:#0b1220; --muted:#95a0b8; --accent:#39b4a3; --danger:#ff6b6b; --warn:#ffb86b; --glass:rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{
    font-family: Inter, system-ui, Arial, sans-serif;
    margin:0; color:#e6eef6;
    background:linear-gradient(180deg,var(--bg) 0%, var(--bg2) 100%);
  }
  header{
    position:sticky; top:0; z-index:50;
    background:linear-gradient(180deg, rgba(7,16,37,0.95), rgba(7,24,39,0.85));
    backdrop-filter: blur(8px);
    border-bottom:1px solid rgba(255,255,255,0.06);
  }
  .wrap{max-width:1200px; margin:0 auto; padding:12px 16px;}
  .brand{display:flex; gap:10px; align-items:center;}
  .brand h1{font-size:18px; margin:0}
  nav{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
  .tab-btn{
    padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.08);
    background:transparent; color:#d9e6f2; cursor:pointer; font-weight:700;
  }
  .tab-btn.active{background:var(--accent); color:#042425; border-color:transparent}
  main{max-width:1200px; margin:12px auto; padding:0 16px;}
  .panel{background:var(--card); padding:14px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.5); margin-bottom:14px}
  .grid{display:grid; gap:14px}
  .grid-2{grid-template-columns: 380px 1fr}
  .grid-3{grid-template-columns: repeat(3,minmax(0,1fr))}
  .grid-4{grid-template-columns: repeat(4,minmax(0,1fr))}
  @media (max-width:1000px){ .grid-2{grid-template-columns:1fr} .grid-3{grid-template-columns:1fr 1fr} .grid-4{grid-template-columns:1fr 1fr}}
  @media (max-width:640px){ .grid-3{grid-template-columns:1fr} .grid-4{grid-template-columns:1fr}}

  label{display:block; font-size:12px; color:var(--muted); margin-top:10px}
  input[type="text"], input[type="number"], input[type="date"], input[type="time"], input[type="file"], select, textarea{
    width:100%; padding:8px 10px; margin-top:6px; border-radius:8px; border:1px solid rgba(255,255,255,0.06);
    background:var(--glass); color:inherit; font-size:13px; outline:none;
  }
  textarea{min-height:72px; resize:vertical}
  .row{display:flex; gap:8px} .row>*{flex:1}

  .btn{display:inline-block; padding:9px 12px; border-radius:8px; border:0; background:var(--accent); color:#042425; font-weight:800; cursor:pointer}
  .btn.ghost{background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.06)}
  .btn.danger{background:var(--danger); color:#fff}
  .btn.small{padding:6px 8px; font-size:12px}

  .stats{display:grid; grid-template-columns: repeat(auto-fill,minmax(180px,1fr)); gap:10px}
  .stat{background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.04); padding:10px; border-radius:10px}
  .stat .label{font-size:12px; color:var(--muted)}
  .stat .value{font-size:18px; font-weight:800; margin-top:6px}

  .cards{display:grid; grid-template-columns: repeat(auto-fill,minmax(320px,1fr)); gap:12px}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.03); border-radius:10px; padding:10px; display:flex; flex-direction:column;
  }
  .meta{display:flex; align-items:center; justify-content:space-between}
  .pair{font-weight:800}
  .chip{padding:4px 8px; border-radius:8px; font-size:12px}
  .buy{background:rgba(57,180,163,0.12); color:var(--accent)}
  .sell{background:rgba(255,107,107,0.08); color:var(--danger)}

  .screenshots{display:flex; gap:8px; margin-top:8px}
  .screenshot{flex:1; max-width:50%; border-radius:8px; background:#071425; padding:6px; object-fit:contain; max-height:220px; width:100%; cursor:pointer}
  @media (max-width:920px){ .screenshots{flex-direction:column} .screenshot{max-width:100%} }

  .trade-notes{margin-top:8px}
  .trade-notes div{margin-bottom:6px}
  .small-muted{font-size:12px; color:var(--muted)}
  .actions{display:flex; gap:8px; margin-top:8px; flex-wrap:wrap}
  .pnl{font-weight:800} .pnl.positive{color:var(--accent)} .pnl.negative{color:var(--danger)}
  .warn{font-size:12px; color:var(--warn)}

  .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .filter-row{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}

  .progress{height:10px; background:rgba(255,255,255,0.06); border-radius:999px; overflow:hidden}
  .progress > div{height:100%; background:var(--accent); width:0%}

  /* Lightbox */
  .lightbox{ position:fixed; inset:0; background:rgba(0,0,0,0.85); display:none; align-items:center; justify-content:center; z-index:9999; }
  .lightbox.open{display:flex}
  .lightbox img{max-width:95vw; max-height:90vh; border-radius:10px}
  .lightbox .close{ position:absolute; top:16px; right:16px; background:#ffffff22; color:#fff; border:0; border-radius:8px; padding:8px 10px; cursor:pointer; }

  canvas{width:100%; height:220px; border-radius:10px; background:rgba(255,255,255,0.02)}
  footer{padding:20px 16px; color:var(--muted); text-align:center}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <div style="width:10px; height:10px; border-radius:50%; background:var(--accent)"></div>
      <h1>Trading Journal Pro</h1>
    </div>
    <nav>
      <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
      <button class="tab-btn" data-tab="add">Add Journey</button>
      <button class="tab-btn" data-tab="view">View Journey</button>
      <button class="tab-btn" data-tab="backup">Export / Import</button>
    </nav>
  </div>
</header>

<main>
  <!-- DASHBOARD -->
  <section id="tab-dashboard" class="tab panel">
    <div class="toolbar" style="justify-content:space-between">
      <div class="toolbar">
        <label>View</label>
        <select id="dashRange">
          <option value="week">This Week</option>
          <option value="month" selected>This Month</option>
          <option value="all">All Time</option>
        </select>
        <label style="margin-left:14px">Monthly Goal (PnL)</label>
        <input type="number" id="monthlyGoal" placeholder="e.g. 1000" style="width:160px"/>
        <button class="btn ghost small" id="saveGoalBtn">Save Goal</button>
      </div>
      <div class="small-muted">Stats update automatically when you add a trade.</div>
    </div>

    <div class="stats" id="dashStats" style="margin-top:10px"></div>

    <div class="grid" style="margin-top:10px">
      <div class="panel" style="padding:10px">
        <div class="small-muted">PnL Trend</div>
        <canvas id="pnlChart" width="800" height="240" aria-label="PnL chart"></canvas>
      </div>
    </div>
  </section>

  <!-- ADD JOURNEY -->
  <section id="tab-add" class="tab panel" style="display:none">
    <div class="grid grid-2">
      <div>
        <form id="tradeForm">
          <label>Date</label>
          <input type="date" id="date" required />
          <label>Time entered</label>
          <input type="time" id="time" required />

          <label>Pair</label>
          <input type="text" id="pair" placeholder="e.g. EUR/USD" required />

          <div class="row">
            <div>
              <label>Position</label>
              <select id="position">
                <option>Buy</option><option>Sell</option>
              </select>
            </div>
            <div>
              <label>Confidence (1–10)</label>
              <input type="number" id="confidence" min="1" max="10" value="5" />
            </div>
          </div>

          <label>Reason (short)</label>
          <input type="text" id="reason" placeholder="Breakout, reversal, news..." />

          <label>Chart Comment</label>
          <input type="text" id="chartComment" placeholder="e.g. resistance flip, wick rejection" />

          <label>Description (context)</label>
          <textarea id="description" placeholder="What happened, session, news, bias..."></textarea>

          <div class="row">
            <div>
              <label>PnL (pips or $) — use + for win, - for loss</label>
              <input type="number" id="pnl" step="0.1" placeholder="e.g. 12.5 or -8" />
            </div>
            <div>
              <label>R:R</label>
              <input type="number" id="rr" step="0.01" placeholder="e.g. 1.50" />
            </div>
          </div>

          <label>Tags (comma separated)</label>
          <input type="text" id="tags" placeholder="e.g. breakout, news, scalping" />

          <label>Screenshot 1 — Higher TF</label>
          <input type="file" id="screenshot1" accept="image/*" />
          <label>Screenshot 2 — Execution TF</label>
          <input type="file" id="screenshot2" accept="image/*" />

          <div style="display:flex; gap:8px; align-items:center; margin-top:8px">
            <button class="btn" id="saveBtn" type="submit">Save Journey</button>
            <button class="btn ghost" type="button" id="clearBtn">Clear</button>
            <div class="warn" id="storageWarn" style="display:none">Tip: very large images still use space — export backups.</div>
          </div>
        </form>
      </div>
      <div>
        <div class="panel">
          <div class="small-muted">Quick Tips</div>
          <ul style="margin:8px 0 0 16px; color:#cfe3f7">
            <li>Use **+** for winners and **-** for losses in PnL.</li>
            <li>Fill **R:R** so Dashboard can average it.</li>
            <li>Two screenshots help future review (HTF + Execution).</li>
          </ul>
        </div>
        <div class="panel">
          <div class="small-muted">Share after save</div>
          <p style="margin:6px 0 0">After saving, you’ll see a **Share** button on the new card (Web Share on mobile supported).</p>
        </div>
      </div>
    </div>
  </section>

  <!-- VIEW JOURNEY -->
  <section id="tab-view" class="tab panel" style="display:none">
    <div class="toolbar">
      <div style="flex:1; min-width:220px">
        <div class="small-muted">Filters / Search</div>
        <div class="filter-row">
          <input type="date" id="fromDate" />
          <input type="date" id="toDate" />
          <input type="text" id="filterPair" placeholder="Filter pair"/>
          <select id="filterResult">
            <option value="all">All</option>
            <option value="win">Wins</option>
            <option value="loss">Losses</option>
          </select>
          <input type="text" id="globalSearch" placeholder="Search text..."/>
        </div>
      </div>
      <div>
        <div class="small-muted">Quick Date Filters</div>
        <div class="filter-row">
          <button class="btn ghost small" id="last7Btn">Last 7 days</button>
          <button class="btn ghost small" id="last30Btn">Last 30 days</button>
          <button class="btn ghost small" id="allBtn">All</button>
        </div>
      </div>
    </div>

    <div class="stats" id="statsArea" style="margin-top:10px"></div>
    <div class="cards" id="cardsContainer" aria-live="polite" style="margin-top:10px"></div>
  </section>

  <!-- BACKUP -->
  <section id="tab-backup" class="tab panel" style="display:none">
    <div class="small-muted">Backup / Import</div>
    <div class="filter-row" style="margin-top:8px">
      <button class="btn ghost" id="exportJsonBtn">Export JSON</button>
      <button class="btn ghost" id="exportCsvBtn">Export CSV (no images)</button>
      <input type="file" id="importFile" />
      <button class="btn danger" id="deleteAllBtn">Delete ALL (careful)</button>
    </div>
  </section>
</main>

<footer>
  Built for you • Blue + Dark theme • Offline • IndexedDB
</footer>

<!-- Lightbox -->
<div class="lightbox" id="lightbox" role="dialog" aria-modal="true" aria-label="Image viewer">
  <button class="close" id="lightboxClose">✕</button>
  <img id="lightboxImg" alt="Full screenshot"/>
</div>

<script>
(()=>{"use strict";

/* ===========================
   IndexedDB WRAPPER
=========================== */
const DB_NAME="tradeJournalDB_v2"; // new name to avoid collisions
const DB_VERSION=1;
const STORE_NAME="trades";

function openDB(){
  return new Promise((resolve,reject)=>{
    const req=indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded=()=> {
      const db=req.result;
      if(!db.objectStoreNames.contains(STORE_NAME)){
        const store=db.createObjectStore(STORE_NAME,{keyPath:"id", autoIncrement:true});
        store.createIndex("date","date",{unique:false});
      }
    };
    req.onsuccess=()=>resolve(req.result);
    req.onerror=()=>reject(req.error);
  });
}
async function idbGetAll(){
  const db=await openDB();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(STORE_NAME,"readonly");
    const store=tx.objectStore(STORE_NAME);
    const r=store.getAll();
    r.onsuccess=()=>resolve(r.result||[]);
    r.onerror=()=>reject(r.error);
  });
}
async function idbAdd(item){
  const db=await openDB();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(STORE_NAME,"readwrite");
    const store=tx.objectStore(STORE_NAME);
    const r=store.add(item);
    r.onsuccess=()=>resolve(r.result);
    r.onerror=()=>reject(r.error);
  });
}
async function idbPut(item){
  const db=await openDB();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(STORE_NAME,"readwrite");
    const store=tx.objectStore(STORE_NAME);
    const r=store.put(item);
    r.onsuccess=()=>resolve(r.result);
    r.onerror=()=>reject(r.error);
  });
}
async function idbDelete(id){
  const db=await openDB();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(STORE_NAME,"readwrite");
    const store=tx.objectStore(STORE_NAME);
    const r=store.delete(id);
    r.onsuccess=()=>resolve();
    r.onerror=()=>reject(r.error);
  });
}
async function idbClear(){
  const db=await openDB();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(STORE_NAME,"readwrite");
    const store=tx.objectStore(STORE_NAME);
    const r=store.clear();
    r.onsuccess=()=>resolve();
    r.onerror=()=>reject(r.error);
  });
}

/* ===========================
   MIGRATION from older LocalStorage (if any)
=========================== */
async function migrateFromLocalStorage(){
  try{
    const ls=localStorage.getItem("trades");
    if(!ls) return;
    const arr=JSON.parse(ls);
    if(!Array.isArray(arr)||arr.length===0) return;
    // bulk insert
    for(const t of arr){ await idbAdd(t); }
    localStorage.removeItem("trades");
    console.log("Migrated from LocalStorage -> IndexedDB");
  }catch(e){ console.warn("Migration failed:", e); }
}

/* ===========================
   HELPERS
=========================== */
const $=id=>document.getElementById(id);
const formatDate=d=>d.toISOString().slice(0,10);
const daysAgoDate=days=>{const d=new Date(); d.setDate(d.getDate()-days); return formatDate(d);};
const debounce=(fn,ms)=>{let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),ms)}};

function parseNum(n){ const v=parseFloat(n); return isNaN(v)?0:v; }

/* Image read + compress */
async function readAndCompress(input,{maxW=1600,maxH=1600,quality=0.82}={}){
  const file=input.files && input.files[0];
  if(!file) return null;
  const img=await fileToImage(file);
  const {width,height}=fit(img.width,img.height,maxW,maxH);
  const c=document.createElement("canvas"); c.width=width; c.height=height;
  const ctx=c.getContext("2d"); ctx.drawImage(img,0,0,width,height);
  let mime="image/webp"; try{ if(!c.toDataURL("image/webp").startsWith("data:image/webp")) mime="image/jpeg"; }catch{ mime="image/jpeg"; }
  return c.toDataURL(mime, quality);
}
function fileToImage(file){
  return new Promise((res,rej)=>{
    const fr=new FileReader();
    fr.onload=()=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.src=fr.result; };
    fr.onerror=rej; fr.readAsDataURL(file);
  });
}
function fit(w,h,maxW,maxH){ const r=Math.min(maxW/w, maxH/h, 1); return {width:Math.round(w*r), height:Math.round(h*r)}; }

/* ===========================
   STATE & ELEMENTS
=========================== */
let trades=[]; // loaded from DB
let editingId=null;

const tabs=[..."dashboard add view backup".split(" ")].map(id=>$("tab-"+id));
const tabBtns=[...document.querySelectorAll(".tab-btn")];

const tradeForm=$("tradeForm");
const dateF=$("date"), timeF=$("time"), pairF=$("pair"), positionF=$("position"),
      confidenceF=$("confidence"), reasonF=$("reason"), chartCommentF=$("chartComment"),
      descriptionF=$("description"), pnlF=$("pnl"), rrF=$("rr"), tagsF=$("tags"),
      screenshot1F=$("screenshot1"), screenshot2F=$("screenshot2");
const storageWarn=$("storageWarn");
const clearBtn=$("clearBtn");

const cardsContainer=$("cardsContainer");
const statsArea=$("statsArea");
const fromDate=$("fromDate"), toDate=$("toDate"), filterPair=$("filterPair"),
      filterResult=$("filterResult"), globalSearch=$("globalSearch");
const last7Btn=$("last7Btn"), last30Btn=$("last30Btn"), allBtn=$("allBtn");

const dashStats=$("dashStats"), dashRange=$("dashRange");
const monthlyGoal=$("monthlyGoal"), saveGoalBtn=$("saveGoalBtn");
const pnlChart=$("pnlChart");

const exportJsonBtn=$("exportJsonBtn"), exportCsvBtn=$("exportCsvBtn"),
      importFile=$("importFile"), deleteAllBtn=$("deleteAllBtn");

/* Lightbox */
const lightbox=$("lightbox"), lightboxImg=$("lightboxImg"), lightboxClose=$("lightboxClose");
lightbox.addEventListener("click",(e)=>{ if(e.target===lightbox || e.target===lightboxClose) lightbox.classList.remove("open"); });

/* ===========================
   NAV
=========================== */
tabBtns.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    tabBtns.forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const tab=btn.dataset.tab;
    tabs.forEach(s=>s.style.display=(s.id==="tab-"+tab)?"block":"none");
    if(tab==="dashboard") renderDashboard();
    if(tab==="view") renderTrades();
  });
});

/* ===========================
   CARDS & VIEW
=========================== */
function createCard(t){
  const pnlNum=parseNum(t.pnl);
  const pnlClass = pnlNum>=0 ? "positive" : "negative";
  const chipClass=(t.position||"").toLowerCase()==="sell"?"sell":"buy";

  const div=document.createElement("article");
  div.className="card";
  div.innerHTML=`
    <div class="meta">
      <div>
        <div class="pair">${escapeHtml(t.pair||"")}</div>
        <div class="small-muted">${t.date||""} ${t.time||""}</div>
      </div>
      <div class="chip ${chipClass}">${t.position||""}</div>
    </div>
    <div class="screenshots">
      ${t.screenshot1?`<img src="${t.screenshot1}" class="screenshot" alt="Screenshot 1" data-id="${t.id}" data-img="1">`:""}
      ${t.screenshot2?`<img src="${t.screenshot2}" class="screenshot" alt="Screenshot 2" data-id="${t.id}" data-img="2">`:""}
    </div>
    <div class="trade-notes">
      <div><strong>Reason:</strong> ${escapeHtml(t.reason||"-")}</div>
      <div><strong>Chart Comment:</strong> ${escapeHtml(t.chartComment||"-")}</div>
      <div><strong>Description:</strong> ${escapeHtml(t.description||"-")}</div>
      <div><strong>PnL:</strong> <span class="pnl ${pnlClass}">${t.pnl||"-"}</span></div>
      <div><strong>R:R:</strong> ${t.rr??"-"}</div>
      <div><strong>Confidence:</strong> ${t.confidence??"-"}</div>
      <div><strong>Tags:</strong> ${(t.tags||"").split(",").map(s=>s.trim()).filter(Boolean).join(", ")||"-"}</div>
    </div>
    <div class="actions">
      <button class="btn ghost small" data-action="edit" data-id="${t.id}">✏️ Edit</button>
      <button class="btn ghost small" data-action="duplicate" data-id="${t.id}">📄 Duplicate</button>
      <button class="btn ghost small" data-action="share" data-id="${t.id}">🔗 Share</button>
      ${t.screenshot1?`<button class="btn ghost small" data-action="download1" data-id="${t.id}">⬇️ Img 1</button>`:""}
      ${t.screenshot2?`<button class="btn ghost small" data-action="download2" data-id="${t.id}">⬇️ Img 2</button>`:""}
      <button class="btn danger small" data-action="delete" data-id="${t.id}">🗑️ Delete</button>
    </div>
  `;
  return div;
}

function renderTrades(){
  const fPair=(filterPair.value||"").trim().toLowerCase();
  const fResult=filterResult.value;
  const fSearch=(globalSearch.value||"").trim().toLowerCase();
  const fFrom=fromDate.value, fTo=toDate.value;

  let filtered=trades.filter(t=>{
    if(fPair && !(t.pair||"").toLowerCase().includes(fPair)) return false;

    const pn=parseNum(t.pnl);
    if(fResult==="win" && pn<=0) return false;
    if(fResult==="loss" && pn>=0) return false;

    if(fFrom && (t.date||"") < fFrom) return false;
    if(fTo && (t.date||"") > fTo) return false;

    if(fSearch){
      const hay=[t.reason,t.chartComment,t.description,t.pair,t.position,t.tags].join(" ").toLowerCase();
      if(!hay.includes(fSearch)) return false;
    }
    return true;
  });

  filtered.sort((a,b)=> (a.date===b.date ? (a.time||"")<(b.time||"")?1:-1 : (a.date||"")<(b.date||"")?1:-1));

  // Stats for view tab
  renderListStats(filtered);

  cardsContainer.innerHTML="";
  if(!filtered.length){ cardsContainer.innerHTML=`<p>No trades match filters.</p>`; return; }
  filtered.forEach(t=> cardsContainer.appendChild(createCard(t)));
}

/* Stats (View tab) */
function renderListStats(list){
  if(!list.length){ statsArea.innerHTML=`<div class="stat">No trades to show stats.</div>`; return; }
  const total=list.length;
  let wins=0, losses=0, pnlSum=0, confSum=0, rrSum=0, rrCount=0;
  for(const t of list){
    const pn=parseNum(t.pnl); pnlSum+=pn; if(pn>0) wins++; else if(pn<0) losses++;
    const cn=parseNum(t.confidence); if(cn) confSum+=cn;
    const rr=parseNum(t.rr); if(rr) { rrSum+=rr; rrCount++; }
  }
  const winRate=(wins/total*100).toFixed(1);
  const lossRate=(losses/total*100).toFixed(1);
  const avgConf=(confSum/total).toFixed(1);
  const avgRR= rrCount? (rrSum/rrCount).toFixed(2):"-";

  statsArea.innerHTML=`
    <div class="stat"><div class="label">Total</div><div class="value">${total}</div></div>
    <div class="stat"><div class="label">Wins</div><div class="value">${wins}</div></div>
    <div class="stat"><div class="label">Losses</div><div class="value">${losses}</div></div>
    <div class="stat"><div class="label">Win Rate</div><div class="value">${winRate}%</div></div>
    <div class="stat"><div class="label">Loss Rate</div><div class="value">${lossRate}%</div></div>
    <div class="stat"><div class="label">Net PnL</div><div class="value">${pnlSum.toFixed(2)}</div></div>
    <div class="stat"><div class="label">Avg R:R</div><div class="value">${avgRR}</div></div>
    <div class="stat"><div class="label">Avg Confidence</div><div class="value">${avgConf}</div></div>
  `;
}

/* ===========================
   DASHBOARD
=========================== */
function startOfWeek(d){ // Monday
  const dt=new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const day=(dt.getDay()+6)%7; // 0=Mon
  dt.setDate(dt.getDate()-day); dt.setHours(0,0,0,0); return dt;
}
function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }

function renderDashboard(){
  const range=dashRange.value;
  const now=new Date();
  let from=null, to=null;

  if(range==="week"){ from=startOfWeek(now); to=new Date(from); to.setDate(to.getDate()+6); }
  else if(range==="month"){ from=startOfMonth(now); to=endOfMonth(now); }
  else { from=new Date(0); to=new Date(8640000000000000); }

  const list=trades.filter(t=>{
    if(!t.date) return false;
    const dt=new Date(t.date+"T00:00:00");
    return dt>=from && dt<=to;
  });

  // aggregates
  let total=list.length, wins=0, losses=0, pnlSum=0, rrSum=0, rrCount=0;
  const perDay={}; // { 'YYYY-MM-DD': sumPnL }
  for(const t of list){
    const pn=parseNum(t.pnl);
    pnlSum+=pn; if(pn>0) wins++; else if(pn<0) losses++;
    const rr=parseNum(t.rr); if(rr){ rrSum+=rr; rrCount++; }
    const d=t.date;
    perDay[d]=(perDay[d]||0)+pn;
  }
  const winRate= total? (wins/total*100).toFixed(1) : "0.0";
  const lossRate= total? (losses/total*100).toFixed(1) : "0.0";
  const avgRR= rrCount? (rrSum/rrCount).toFixed(2) : "-";

  // best / worst day
  let bestDay=null, worstDay=null;
  for(const d in perDay){
    const v=perDay[d];
    if(bestDay===null || v>(bestDay.value||-Infinity)) bestDay={date:d, value:v};
    if(worstDay===null || v<(worstDay.value||Infinity)) worstDay={date:d, value:v};
  }

  // monthly goal progress
  const goal=parseNum(localStorage.getItem("monthlyGoal")||monthlyGoal.value);
  const progress = (goal>0 && range!=="week") ? Math.max(0, Math.min(100, (pnlSum/goal)*100)) : null;

  dashStats.innerHTML = `
    <div class="stat"><div class="label">${range==="week"?"This Week":"This Month"}</div><div class="value">${pnlSum.toFixed(2)}</div></div>
    <div class="stat"><div class="label">Trades</div><div class="value">${total}</div></div>
    <div class="stat"><div class="label">Win / Loss</div><div class="value">${wins} / ${losses}</div></div>
    <div class="stat"><div class="label">Win Rate</div><div class="value">${winRate}%</div></div>
    <div class="stat"><div class="label">Loss Rate</div><div class="value">${lossRate}%</div></div>
    <div class="stat"><div class="label">Avg R:R</div><div class="value">${avgRR}</div></div>
    <div class="stat"><div class="label">Best Day</div><div class="value">${bestDay?`${bestDay.value.toFixed(2)} (${bestDay.date})`:"-"}</div></div>
    <div class="stat"><div class="label">Worst Day</div><div class="value">${worstDay?`${worstDay.value.toFixed(2)} (${worstDay.date})`:"-"}</div></div>
    ${progress!==null?`<div class="stat"><div class="label">Monthly Goal</div><div class="value">
      <div class="progress" aria-label="Goal progress"><div style="width:${progress.toFixed(0)}%"></div></div>
      <div class="small-muted" style="margin-top:4px">${pnlSum.toFixed(2)} / ${goal.toFixed(2)} (${progress.toFixed(0)}%)</div>
    </div></div>`:""}
  `;

  drawPnLChart(range, from, to, perDay);
}

/* Tiny Canvas chart (daily PnL sum) */
function drawPnLChart(range, from, to, perDay){
  const ctx=pnlChart.getContext("2d");
  ctx.clearRect(0,0,pnlChart.width,pnlChart.height);
  // prepare days
  const labels=[]; const values=[];
  const cur=new Date(from);
  while(cur<=to){
    const key=cur.toISOString().slice(0,10);
    labels.push(key);
    values.push(perDay[key]||0);
    cur.setDate(cur.getDate()+1);
  }
  if(!labels.length){ return; }

  // compute scales
  const W=pnlChart.width, H=pnlChart.height, P=24; // padding
  const min=Math.min(0, ...values), max=Math.max(0, ...values);
  const span=(max-min)||1;
  function x(i){ return P + i*( (W-2*P) / (labels.length-1||1) ); }
  function y(v){ return H-P - ((v-min)/span)*(H-2*P); }

  // axes (zero line)
  ctx.lineWidth=1; ctx.strokeStyle="rgba(255,255,255,0.18)";
  const y0=y(0); ctx.beginPath(); ctx.moveTo(P,y0); ctx.lineTo(W-P,y0); ctx.stroke();

  // line
  ctx.lineWidth=2; ctx.beginPath();
  for(let i=0;i<values.length;i++){
    const px=x(i), py=y(values[i]);
    if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
  }
  ctx.strokeStyle="#39b4a3"; ctx.stroke();

  // points
  ctx.fillStyle="#39b4a3";
  for(let i=0;i<values.length;i++){ ctx.beginPath(); ctx.arc(x(i), y(values[i]), 3, 0, Math.PI*2); ctx.fill(); }
}

/* ===========================
   FORM: SAVE / EDIT
=========================== */
tradeForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const img1 = screenshot1F.files.length ? await readAndCompress(screenshot1F) : null;
  const img2 = screenshot2F.files.length ? await readAndCompress(screenshot2F) : null;

  const base={
    date:dateF.value, time:timeF.value, pair:pairF.value.trim(), position:positionF.value,
    confidence:confidenceF.value.trim(), reason:reasonF.value.trim(), chartComment:chartCommentF.value.trim(),
    description:descriptionF.value.trim(), pnl:pnlF.value.trim(), rr:rrF.value.trim(), tags:tagsF.value.trim()
  };
  if(!base.date || !base.time || !base.pair){ alert("Please fill Date, Time, Pair."); return; }

  if(editingId===null){
    const trade={...base, screenshot1:img1||null, screenshot2:img2||null, createdAt:Date.now()};
    const id=await idbAdd(trade); trade.id=id; trades.push(trade);
    toastShare(trade); // offer share
  }else{
    const old=trades.find(t=>t.id===editingId); if(!old) return;
    const upd={...old, ...base,
      screenshot1: img1!==null?img1:old.screenshot1,
      screenshot2: img2!==null?img2:old.screenshot2,
      updatedAt:Date.now()
    };
    await idbPut(upd);
    trades[trades.findIndex(t=>t.id===editingId)]=upd;
    editingId=null;
  }
  tradeForm.reset();
  storageWarn.style.display="none";
  renderTrades(); renderDashboard();
  // switch to View tab to see the new card
  switchTab("view");
});

clearBtn.addEventListener("click", ()=>{ editingId=null; tradeForm.reset(); });

/* Share toast (after save) */
async function toastShare(t){
  // try Web Share
  const text=`${t.date} ${t.time} • ${t.pair} • ${t.position}
PnL: ${t.pnl} | R:R: ${t.rr||"-"}
Reason: ${t.reason||"-"}
Comment: ${t.chartComment||"-"}`;
  if(navigator.share){
    try{
      await navigator.share({ title:`Trade — ${t.pair}`, text });
      return;
    }catch(e){ /* user canceled */ }
  }
  // fallback: copy to clipboard
  try{ await navigator.clipboard.writeText(text); alert("Trade saved! Summary copied to clipboard."); }
  catch{ alert("Trade saved! (Share not supported on this device)"); }
}

/* ===========================
   CARD ACTIONS
=========================== */
cardsContainer.addEventListener("click", async (e)=>{
  const btn=e.target.closest("button[data-action]");
  const img=e.target.closest("img.screenshot");
  if(img){
    lightboxImg.src=img.src; lightbox.classList.add("open"); return;
  }
  if(!btn) return;
  const id=Number(btn.dataset.id);
  const t=trades.find(x=>x.id===id); if(!t) return;

  const act=btn.dataset.action;
  if(act==="edit"){ editingId=id; fillForm(t); switchTab("add"); window.scrollTo({top:0,behavior:"smooth"}); }
  else if(act==="delete"){
    if(confirm("Delete this trade?")){ await idbDelete(id); trades=trades.filter(x=>x.id!==id); renderTrades(); renderDashboard(); }
  }
  else if(act==="duplicate"){
    const copy={...t, id:undefined, date:formatDate(new Date()), time:new Date().toTimeString().slice(0,5), createdAt:Date.now(), updatedAt:undefined};
    const nid=await idbAdd(copy); copy.id=nid; trades.push(copy); renderTrades(); renderDashboard();
  }
  else if(act==="download1"){ if(t.screenshot1) downloadImage(t.screenshot1, `trade_${id}_img1.png`); }
  else if(act==="download2"){ if(t.screenshot2) downloadImage(t.screenshot2, `trade_${id}_img2.png`); }
  else if(act==="share"){ toastShare(t); }
});
function fillForm(t){
  dateF.value=t.date||""; timeF.value=t.time||""; pairF.value=t.pair||"";
  positionF.value=t.position||"Buy"; confidenceF.value=t.confidence||"";
  reasonF.value=t.reason||""; chartCommentF.value=t.chartComment||"";
  descriptionF.value=t.description||""; pnlF.value=t.pnl||"";
  rrF.value=t.rr||""; tagsF.value=t.tags||"";
  screenshot1F.value=""; screenshot2F.value="";
}
function downloadImage(dataUrl, filename){
  const a=document.createElement("a"); a.href=dataUrl; a.download=filename;
  document.body.appendChild(a); a.click(); a.remove();
}

/* ===========================
   FILTERS (VIEW)
=========================== */
const doFilter=debounce(renderTrades,200);
[fromDate,toDate,filterPair,filterResult,globalSearch].forEach(el=> el.addEventListener(el.tagName==="SELECT"?"change":"input", doFilter));
last7Btn.addEventListener("click",()=>{ fromDate.value=daysAgoDate(7); toDate.value=formatDate(new Date()); doFilter(); });
last30Btn.addEventListener("click",()=>{ fromDate.value=daysAgoDate(30); toDate.value=formatDate(new Date()); doFilter(); });
allBtn.addEventListener("click",()=>{ fromDate.value=""; toDate.value=""; doFilter(); });

/* ===========================
   DASHBOARD CONTROLS
=========================== */
dashRange.addEventListener("change", renderDashboard);
saveGoalBtn.addEventListener("click", ()=>{ localStorage.setItem("monthlyGoal", monthlyGoal.value||""); renderDashboard(); });

/* ===========================
   BACKUP
=========================== */
exportJsonBtn.addEventListener("click", ()=>{
  const blob=new Blob([JSON.stringify(trades,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a");
  a.href=url; a.download="trade_journal_backup.json"; document.body.appendChild(a); a.click();
  URL.revokeObjectURL(url); a.remove();
});
exportCsvBtn.addEventListener("click", ()=>{
  const keys=["id","date","time","pair","position","confidence","reason","chartComment","description","pnl","rr","tags"];
  const rows=[keys.join(",")];
  for(const t of trades){
    const row=keys.map(k=>{
      let v=(t[k]??"").toString().replace(/"/g,'""');
      if(v.includes(",")||v.includes("\n")) v='"'+v+'"';
      return v;
    });
    rows.push(row.join(","));
  }
  const blob=new Blob([rows.join("\n")],{type:"text/csv"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a");
  a.href=url; a.download="trade_journal.csv"; document.body.appendChild(a); a.click();
  URL.revokeObjectURL(url); a.remove();
});
importFile.addEventListener("change", async (e)=>{
  const file=e.target.files[0]; if(!file) return;
  try{
    const text=await file.text(); const data=JSON.parse(text);
    if(!Array.isArray(data)) throw new Error("Invalid JSON");
    if(!confirm("Importing will REPLACE all existing trades. Continue?")) return;
    await idbClear();
    for(const t of data){ const {id,...rest}=t; await idbAdd(rest); }
    trades=await idbGetAll(); renderTrades(); renderDashboard();
    alert("Import successful.");
  }catch(err){ alert("Import failed: "+err.message); }
  finally{ importFile.value=""; }
});
deleteAllBtn.addEventListener("click", async ()=>{
  if(confirm("Delete ALL trades? This cannot be undone.")){
    await idbClear(); trades=[]; renderTrades(); renderDashboard();
  }
});

/* ===========================
   UTILS
=========================== */
function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
function switchTab(name){
  tabBtns.forEach(b=>{ b.classList.toggle("active", b.dataset.tab===name); });
  tabs.forEach(s=> s.style.display=(s.id==="tab-"+name)?"block":"none");
}

/* ===========================
   INIT
=========================== */
(async function init(){
  // load goal
  const g=localStorage.getItem("monthlyGoal"); if(g) monthlyGoal.value=g;
  await migrateFromLocalStorage();
  trades=await idbGetAll();
  renderDashboard();
  renderTrades();
})();
})();</script>
</body>
</html>
